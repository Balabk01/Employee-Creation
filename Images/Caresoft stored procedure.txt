USE [CARCOM]
GO

/****** Object:  StoredProcedure [dbo].[sp_AR_DTL_Sel]    Script Date: 04-Aug-23 12:46:36 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_AR_DTL_Sel]--exec sp_AR_DTL_Sel 'CAR001','CSMH2010005'
	-- Add the parameters for the stored procedure here
	@INVUNIQ NVARCHAR(40)=NULL,
	@DOCNO NVARCHAR(30)= NULL
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
SELECT 
CONVERT(NVARCHAR(30),RTRIM(BL.IDCUST)) INVUNIQ,--BATCH AND ENTRY NUMBER
CONVERT(NVARCHAR(40),REPLACE(RTRIM(BL.IDINVC),' ','')) INVNUMBER,
CONVERT(NVARCHAR(6),((ROW_NUMBER() OVER(PARTITION BY BL.IDINVC ORDER BY BL.IDINVC)))) [ITEMLST_SINO],
CONVERT(NVARCHAR(300),BD.TEXTDESC) [ITEMLST_PRODDESC],
CASE WHEN CONVERT(NVARCHAR(8),RTRIM(replace(BDO1.ISSERV,' ','')))='1' THEN 'Y' ELSE 'N' END [ITEMLST_ISSERV],
-- 'Y' [ITEMLST_ISSERV],
--'998338' [ITEMLST_HSNCD],
CONVERT(NVARCHAR(8),RTRIM(replace(BDO.HSN,' ',''))) [ITEMLST_HSNCD],
BL.IDINVC [ITEMLST_BCHDTLSNM],
1 [ITEMLST_BCHDTLQTY],
'NOS' [ITEMLST_BCHDTLUNIT],
CONVERT(decimal(12,2),BD.AMTEXTNHC) [ITEMLST_BCHDTLUNITPRICE],
CONVERT(decimal(12,2),BD.AMTEXTNHC) [ITEMLST_BCHDTLTOTAMT],
0 [ITEMLST_BCHDTLDISCOUNT],
CONVERT(decimal(12,2),BD.AMTEXTNHC) [ITEMLST_BCHDTLASSAMTVAL],
CASE WHEN BD.TAXSTTS1=3 AND BL.CODETAX1 LIKE '%GST%'  THEN 18 
WHEN BD.TAXSTTS1=4 AND BL.CODETAX1 LIKE '%GST%'  THEN 28 
WHEN BD.TAXSTTS1=1 AND BL.CODETAX1 LIKE '%GST%'  THEN 5
WHEN BD.TAXSTTS1=2 AND BL.CODETAX1 LIKE '%GST%'  THEN 12 
ELSE 0 END [ITEMLST_BCHDTLGSTRT],
CASE WHEN BL.CODETAX1 LIKE '%IGST%' THEN CONVERT(decimal(12,2),BD.TXAMT1HC) ELSE 0 END [ITEMLST_BCHDTLIGSTAMTVAL],
CASE WHEN BL.CODETAX1 LIKE '%CGST%' THEN CONVERT(decimal(12,2),BD.TXAMT1HC) ELSE 0 END [ITEMLST_BCHDTLCGSTAMTVAL],
CASE WHEN BL.CODETAX2 LIKE '%SGST%' THEN CONVERT(decimal(12,2),BD.TXAMT2HC) ELSE 0 END [ITEMLST_BCHDTLSGSTAMTVAL],
CONVERT(decimal(12,2),BD.AMTEXTNHC+BD.TXAMT1HC+BD.TXAMT2HC) [ITEMLST_BCHDTLTOTITEMVAL]
FROM  AROBL BL 
LEFT JOIN ARIBD BD ON BD.CNTBTCH=BL.CNTBTCH AND BD.CNTITEM=BL.CNTITEM
LEFT JOIN (SELECT CNTBTCH,CNTITEM,CNTLINE,[VALUE] HSN FROM ARIBDO WHERE OPTFIELD='HSNCODE') BDO ON BDO.CNTBTCH=BD.CNTBTCH 
AND BDO.CNTITEM=BD.CNTITEM AND BDO.CNTLINE=BD.CNTLINE
LEFT JOIN (SELECT CNTBTCH,CNTITEM,CNTLINE,[VALUE] ISSERV FROM ARIBDO WHERE OPTFIELD='ISSERVICE') BDO1 ON BDO1.CNTBTCH=BD.CNTBTCH 
AND BDO1.CNTITEM=BD.CNTITEM AND BDO1.CNTLINE=BD.CNTLINE
WHERE 
BL.DEPLINE=0  AND BL.SRCEAPPL<>'OE' and BL.TRXTYPETXT IN (1,2,3) and BL.CODETAXGRP LIKE '%GST%' 
AND BL.IDINVC=@DOCNO AND BL.IDCUST=@INVUNIQ
order by BL.DATEINVC,BL.IDCUST,BL.IDINVC,BD.CNTLINE

END

GO


